From 533b4109295a84b1bd99b2cc0d876030ce34d160 Mon Sep 17 00:00:00 2001
From: Scott Ware <scott.r.ware@intel.com>
Date: Tue, 15 Nov 2016 17:31:35 +0000
Subject: [PATCH] Skip building shared util library if provided

---
 CMakeLists.txt | 17 +++++++++++++++--
 1 file changed, 15 insertions(+), 2 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 00b9c24..08144ec 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -87,7 +87,18 @@ set_property(GLOBAL PROPERTY USE_FOLDERS ON)
 add_definitions(-DREFCOUNT_ATOMIC_DONTCARE)
 add_definitions(-D__STDC_NO_ATOMICS__=1)
 
-add_subdirectory(c-utility)
+find_library (SHARED_UTIL_LIB_PATH NAMES aziotsharedutil)
+
+# Check if shared utils library is already provided
+if (SHARED_UTIL_LIB_PATH AND SHARED_UTIL_INCLUDE_DIR)
+    set(SHARED_UTIL_FOUND 1)
+endif()
+
+if (NOT SHARED_UTIL_FOUND)
+    add_subdirectory(c-utility)
+    set(SHARED_UTIL_LIB_PATH aziotsharedutil)
+    set(SHARED_UTIL_INCLUDE_DIR ${SHARED_UTIL_INC_FOLDER})
+endif()
 
 enable_testing()
 #if any compiler has a command line switch called "OFF" then it will need special care
@@ -132,7 +143,7 @@ endmacro(compileAsC11)
 
 option(memory_trace "set memory_trace to ON if memory usage is to be used, set to OFF to not use it" ON)
 
-include_directories(${CMAKE_CURRENT_LIST_DIR}/inc ${SHARED_UTIL_INC_FOLDER})
+include_directories(${CMAKE_CURRENT_LIST_DIR}/inc ${SHARED_UTIL_INCLUDE_DIR})
 
 add_definitions(-D_CRT_SECURE_NO_WARNINGS)
 
@@ -215,6 +226,8 @@ add_library(uamqp
     ${socketlistener_c_files}
     )
 
+target_link_libraries(uamqp ${SHARED_UTIL_LIB_PATH})
+
 if (NOT ${ARCHITECTURE} STREQUAL "ARM")
     add_subdirectory(samples)
 endif()
-- 
1.9.1

