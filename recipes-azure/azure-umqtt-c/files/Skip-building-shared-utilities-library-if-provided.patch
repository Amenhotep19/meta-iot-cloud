From 757e1f6eb65b0f2bb450cbabed16bbc42112b84c Mon Sep 17 00:00:00 2001
From: Scott Ware <scott.r.ware@intel.com>
Date: Tue, 15 Nov 2016 17:45:38 +0000
Subject: [PATCH 1/2] Skip building shared utilities library if provided

---
 CMakeLists.txt | 18 +++++++++++++++---
 1 file changed, 15 insertions(+), 3 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 47f270c..60b7397 100755
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -68,7 +68,19 @@ message(STATUS "MQTT Target architecture: ${ARCHITECTURE}")
 # Start of variables used during install
 #set (INCLUDE_INSTALL_DIR include CACHE PATH "Include file directory")
 
-add_subdirectory(c-utility)
+# Check if shared utils library is already provided
+find_library (SHARED_UTIL_LIB_PATH NAMES aziotsharedutil)
+
+if (SHARED_UTIL_LIB_PATH AND SHARED_UTIL_INCLUDE_DIR)
+    set(SHARED_UTIL_FOUND 1)
+endif()
+
+# Build shared util library if not found
+if (NOT SHARED_UTIL_FOUND)
+    add_subdirectory(c-utility)
+    set(SHARED_UTIL_LIB_PATH aziotsharedutil)
+    set(SHARED_UTIL_INCLUDE_DIR ${SHARED_UTIL_INC_FOLDER})
+endif()
 
 enable_testing()
 
@@ -134,7 +146,7 @@ set(source_h_files
 #the following "set" statetement exports across the project a global variable called COMMON_INC_FOLDER that expands to whatever needs to included when using COMMON library
 set(MQTT_INC_FOLDER ${CMAKE_CURRENT_LIST_DIR}/inc CACHE INTERNAL "this is what needs to be included if using sharedLib lib" FORCE)
 set(MQTT_SRC_FOLDER ${CMAKE_CURRENT_LIST_DIR}/src CACHE INTERNAL "this is what needs to be included when doing include sources" FORCE)
-include_directories(${MQTT_INC_FOLDER} ${SHARED_UTIL_INC_FOLDER})
+include_directories(${MQTT_INC_FOLDER} ${SHARED_UTIL_INCLUDE_DIR})
 
 get_directory_property(hasParent PARENT_DIRECTORY)
 if(hasParent)
@@ -157,7 +169,7 @@ add_library(umqtt ${source_c_files} ${source_h_files})
 
 set(SHARED_UTIL_ADAPTER_FOLDER "${CMAKE_CURRENT_LIST_DIR}/c-utility/adapters")
 
-target_link_libraries(umqtt aziotsharedutil)
+target_link_libraries(umqtt ${SHARED_UTIL_LIB_PATH})
 
 if (NOT ${ARCHITECTURE} STREQUAL "ARM")
     add_subdirectory(samples)
-- 
1.9.1

